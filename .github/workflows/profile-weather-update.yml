name: Profile Weather Update

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Workflow triggers
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
on:
  schedule:
    - cron: "23 5,13,21 * * *"

  workflow_dispatch:
    inputs:
      force_update:
        description: Force README update regardless of changes
        type: boolean
        default: false
      skip_tests:
        description: Skip test execution
        type: boolean
        default: false

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Concurrency control
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Permissions
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
permissions:
  contents: write
  id-token: write

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Environment variables
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
env:
  CACHE_KEY_PREFIX: v15-profile-weather
  TIMEZONE: Asia/Dhaka
  PROFILE_REPO: tashfiqul-islam/tashfiqul-islam
  NODE_ENV: production
  FORCE_UPDATE: ${{ github.event.inputs.force_update || 'false' }}
  SKIP_TESTS: ${{ github.event.inputs.skip_tests || 'false' }}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Jobs
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
jobs:
  update-weather:
    name: Update Weather Data
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      api_response_time: ${{ steps.update-weather-and-readme.outputs.API_RESPONSE_TIME }}
      cache_hit: ${{ steps.cache-deps.outputs.cache-hit }}
      changes_detected: ${{ steps.update-weather-and-readme.outputs.changes_detected }}

    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Repository Checkout
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout weather repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          repository: ${{ github.repository }}
          fetch-depth: 0
          persist-credentials: false

      - name: Checkout profile repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          repository: ${{ env.PROFILE_REPO }}
          path: profile-repo
          token: ${{ secrets.PAT }}
          fetch-depth: 1
          ref: master
          persist-credentials: false

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Runtime Setup
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Setup Bun
        uses: oven-sh/setup-bun@b7a1c7ccf290d58743029c4f6903da283811b979 # v2.1.0
        with:
          bun-version: latest

      - name: Restore dependencies cache
        id: cache-deps
        uses: actions/cache/restore@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: |
            node_modules
            ~/.bun/install/cache
            bun.lock
          key: ${{ env.CACHE_KEY_PREFIX }}-${{ runner.os }}-bun-${{ hashFiles('package.json', 'bun.lock') }}
          restore-keys: |
            ${{ env.CACHE_KEY_PREFIX }}-${{ runner.os }}-bun-

      - name: Install dependencies
        run: |
          if [[ "${{ steps.cache-deps.outputs.cache-hit }}" != "true" ]]; then
            echo "::group::Installing dependencies"
            bun --version
          else
            echo "::notice::Using cached dependencies"
          fi
          bun install --no-summary
          echo "::endgroup::"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Quality Checks
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run quality checks
        if: env.SKIP_TESTS != 'true'
        run: |
          echo "::group::Quality checks"
          bun run lint src/
          bun run typecheck
          echo "::endgroup::"

      - name: Run tests
        if: env.SKIP_TESTS != 'true'
        run: |
          echo "::group::Test execution"
          bun run src/scripts/test-pretty.ts --no-live
          echo "::endgroup::"
        env:
          CI: "true"

      - name: Skip quality checks
        if: env.SKIP_TESTS == 'true'
        run: echo "::notice::Skipping quality checks"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Weather Update
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Verify profile README
        run: |
          if [[ ! -f "profile-repo/README.md" ]]; then
            echo "::error::README.md file not found in profile repository"
            exit 1
          fi
          if ! grep -q "<!-- Hourly Weather Update -->" profile-repo/README.md; then
            echo "::error::Weather section not found in README.md"
            exit 1
          fi
          echo "::notice::Weather section verified"

      - name: Update weather and README
        id: update-weather-and-readme
        env:
          GITHUB_ACTIONS: "true"
          PROFILE_README_PATH: profile-repo/README.md
          FORCE_UPDATE: ${{ env.FORCE_UPDATE }}
        run: |
          echo "::group::Weather update"

          START_TIME=$(date +%s.%N)

          if [[ ! -f "$PROFILE_README_PATH" ]]; then
            echo "::error::README file not found"
            exit 1
          fi

          OUTPUT=$(bun run src/weather-update/index.ts)
          EXECUTION_STATUS=$?

          END_TIME=$(date +%s.%N)
          ELAPSED_TIME=$(echo "$END_TIME - $START_TIME" | bc)
          echo "API_RESPONSE_TIME=$ELAPSED_TIME" >> "$GITHUB_OUTPUT"

          if [[ $EXECUTION_STATUS -ne 0 ]]; then
            echo "::error::Weather update failed with code $EXECUTION_STATUS"
            echo "$OUTPUT"
            exit $EXECUTION_STATUS
          fi

          if echo "$OUTPUT" | grep -q "CHANGES_DETECTED=true"; then
            echo "changes_detected=true" >> "$GITHUB_OUTPUT"
          elif [[ "${{ env.FORCE_UPDATE }}" == "true" ]]; then
            echo "changes_detected=true" >> "$GITHUB_OUTPUT"
          else
            echo "changes_detected=false" >> "$GITHUB_OUTPUT"
          fi

          echo "Execution time: ${ELAPSED_TIME}s"
          echo "$OUTPUT"
          echo "::endgroup::"

      - name: Save dependencies cache
        if: always() && steps.cache-deps.outputs.cache-hit != 'true'
        uses: actions/cache/save@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: |
            node_modules
            ~/.bun/install/cache
            bun.lock
          key: ${{ steps.cache-deps.outputs.cache-primary-key }}

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Commit Signing & Push
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Validate GPG secret
        if: github.event_name == 'schedule' || steps.update-weather-and-readme.outputs.changes_detected == 'true'
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          if [ -z "${GPG_PRIVATE_KEY}" ]; then
            echo "::error::Missing secret GPG_PRIVATE_KEY"
            exit 1
          fi
          if ! grep -q "BEGIN PGP PRIVATE KEY BLOCK" <<< "${GPG_PRIVATE_KEY}"; then
            echo "::error::GPG_PRIVATE_KEY is not ASCII-armored"
            exit 1
          fi
          if ! grep -q "END PGP PRIVATE KEY BLOCK" <<< "${GPG_PRIVATE_KEY}"; then
            echo "::error::GPG_PRIVATE_KEY footer missing"
            exit 1
          fi

      - name: Setup GPG for commit signing
        id: gpg-setup
        if: github.event_name == 'schedule' || steps.update-weather-and-readme.outputs.changes_detected == 'true'
        uses: crazy-max/ghaction-import-gpg@e89d40939c28e39f97cf32126055eeae86ba74ec # v6.3.0
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}
          git_user_signingkey: true
          git_config_global: true
          git_commit_gpgsign: true
          git_tag_gpgsign: true
          git_push_gpgsign: if-asked
        env:
          GPG_TTY: /dev/console

      - name: Configure Git identity
        if: github.event_name == 'schedule' || steps.update-weather-and-readme.outputs.changes_detected == 'true'
        run: |
          git config --global user.name "${{ secrets.GIT_COMMITTER_NAME || github.repository_owner }}"
          git config --global user.email "${{ secrets.GIT_COMMITTER_EMAIL }}"

      - name: Commit and push changes
        if: github.event_name == 'schedule' || steps.update-weather-and-readme.outputs.changes_detected == 'true'
        working-directory: profile-repo
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}
        run: |
          echo "::group::Git operations"

          export GIT_AUTHOR_DATE="$(TZ='Asia/Dhaka' date)"
          export GIT_COMMITTER_DATE="$GIT_AUTHOR_DATE"
          FORMATTED_DATE=$(TZ="Asia/Dhaka" date "+%Y-%m-%d %H:%M:%S %Z")

          if git diff --quiet -- README.md; then
            if [[ "${{ github.event_name }}" == "schedule" ]]; then
              echo "::notice::No weather changes detected"
            elif [[ "${{ env.FORCE_UPDATE }}" == "true" ]]; then
              echo "::warning::Force update requested but no changes to commit"
            else
              echo "::notice::No changes detected"
            fi
          else
            git add README.md
            git commit -S --no-verify -m "update(weather): refresh data for ${FORMATTED_DATE}"
            git push https://x-access-token:${{ secrets.PAT }}@github.com/${{ env.PROFILE_REPO }} HEAD:master
            echo "::notice::Changes pushed successfully"
          fi
          echo "::endgroup::"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Verification job
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  verify:
    name: Verify & Report
    needs: update-weather
    if: always()
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 2

    steps:
      - name: Generate execution report
        run: |
          {
            echo "# Profile Weather Update Report"
            echo ""
            echo "## Execution Details"
            echo ""
            echo "| Property | Value |"
            echo "|----------|-------|"
            echo "| **Run ID** | \`${{ github.run_id }}\` |"
            echo "| **Time** | $(TZ='${{ env.TIMEZONE }}' date '+%Y-%m-%d %H:%M:%S %Z') |"
            echo "| **Trigger** | ${{ github.event_name }} |"
            echo "| **Target** | ${{ env.PROFILE_REPO }} |"
            echo "| **Mode** | ${{ env.FORCE_UPDATE == 'true' && 'Force Update' || 'Normal' }} |"
            echo "| **Tests** | ${{ env.SKIP_TESTS == 'true' && 'Skipped' || 'Executed' }} |"
            echo ""
            echo "## Status"
            echo ""
            echo "| Job | Result |"
            echo "|-----|--------|"
            echo "| **Weather Update** | ${{ needs.update-weather.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |"
            echo "| **Cache Hit** | ${{ needs.update-weather.outputs.cache_hit == 'true' && 'âœ… Yes' || 'â­ï¸ No' }} |"
            echo "| **Changes** | ${{ needs.update-weather.outputs.changes_detected == 'true' && 'ðŸ“ Detected' || 'âœ“ None' }} |"
            echo ""
          } >> "$GITHUB_STEP_SUMMARY"

          # Performance metrics
          if [[ -n "${{ needs.update-weather.outputs.api_response_time }}" ]]; then
            RESPONSE_TIME="${{ needs.update-weather.outputs.api_response_time }}"
            {
              echo "## Performance"
              echo ""
              echo "| Metric | Value |"
              echo "|--------|-------|"
              echo "| **Response Time** | ${RESPONSE_TIME}s |"
            } >> "$GITHUB_STEP_SUMMARY"

            if (( $(echo "$RESPONSE_TIME < 1.0" | bc -l) )); then
              echo "| **Rating** | ðŸŸ¢ Excellent (< 1s) |" >> "$GITHUB_STEP_SUMMARY"
            elif (( $(echo "$RESPONSE_TIME < 2.0" | bc -l) )); then
              echo "| **Rating** | ðŸŸ¡ Good (< 2s) |" >> "$GITHUB_STEP_SUMMARY"
            else
              echo "| **Rating** | ðŸ”´ Slow (> 2s) |" >> "$GITHUB_STEP_SUMMARY"
            fi
          fi

      - name: Schedule next update
        run: |
          NEXT_UPDATE_TIME=$(TZ="${{ env.TIMEZONE }}" date -d "+8 hours" "+%H:%M:%S %Z")
          echo "::notice title=Next Update::Scheduled for approximately ${NEXT_UPDATE_TIME}"
          {
            echo ""
            echo "## Next Update"
            echo ""
            echo "â° Scheduled for approximately **${NEXT_UPDATE_TIME}**"
          } >> "$GITHUB_STEP_SUMMARY"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Recovery job
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  recovery:
    name: Recovery Actions
    needs: [update-weather, verify]
    if: always() && (needs.update-weather.result == 'failure' || needs.verify.result == 'failure')
    runs-on: ubuntu-latest
    timeout-minutes: 3

    steps:
      - name: Analyze failure
        run: |
          {
            echo "# âš ï¸ Workflow Failure Analysis"
            echo ""
            echo "## Failed Jobs"
            echo ""
            echo "| Job | Status |"
            echo "|-----|--------|"
          } >> "$GITHUB_STEP_SUMMARY"

          if [[ "${{ needs.update-weather.result }}" == "failure" ]]; then
            echo "| **Weather Update** | âŒ Failed |" >> "$GITHUB_STEP_SUMMARY"
          fi

          if [[ "${{ needs.verify.result }}" == "failure" ]]; then
            echo "| **Verification** | âŒ Failed |" >> "$GITHUB_STEP_SUMMARY"
          fi

          {
            echo ""
            echo "## Recovery Status"
            echo ""
            echo "- ðŸ”„ Recovery mode activated"
            echo "- ðŸ“§ Notification created for manual intervention"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Schedule re-run
        run: |
          DELAY_MINUTES=$((15 * 2 ** (${{ github.run_attempt }} - 1)))
          DELAY_MINUTES=$((DELAY_MINUTES > 240 ? 240 : DELAY_MINUTES))
          NEXT_RETRY=$(date -d "+${DELAY_MINUTES} minutes" "+%H:%M:%S")

          echo "::notice title=Automatic Retry::Scheduled in ${DELAY_MINUTES} minutes (at approximately ${NEXT_RETRY})"
          {
            echo ""
            echo "## Retry Schedule"
            echo ""
            echo "ðŸ” Next automatic retry in **${DELAY_MINUTES} minutes** (at ${NEXT_RETRY})"
          } >> "$GITHUB_STEP_SUMMARY"
