name: "ðŸš€ Semantic Release"

# ============================================================
# âš¡ Trigger Configuration
# ============================================================
on:
  push:
    branches:
      - master
    paths-ignore:
      - 'CHANGELOG.md'
      - 'package.json'
      - '*.md'

  workflow_dispatch:
    inputs:
      debug:
        description: "Enable debug logging"
        required: false
        default: "false"
        type: choice
        options:
          - "true"
          - "false"
      dry_run:
        description: "Run in dry-run mode (no actual release)"
        type: boolean
        default: false

# ============================================================
# ðŸš« Prevent Redundant Runs
# ============================================================
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# ============================================================
# ðŸ”’ Permissions (Least Privilege Principle)
# ============================================================
permissions:
  contents: write  # For repository updates, Git tags
  issues: write    # For issue comments
  pull-requests: write  # For PR comments
  id-token: write  # For provenance generation (npm best practice)

# ============================================================
# ðŸŒ Environment Variables
# ============================================================
env:
  GH_TOKEN: ${{ secrets.PAT }}
  NODE_ENV: "production"
  BUN_RUNTIME_SAFETY: "true"
  DEBUG: ${{ github.event.inputs.debug == 'true' && 'semantic-release:*' || '' }}
  DRY_RUN: ${{ github.event.inputs.dry_run == 'true' || 'false' }}
  GIT_AUTHOR_NAME: "GitHub Actions"
  GIT_AUTHOR_EMAIL: "github-actions@github.com"
  GIT_COMMITTER_NAME: "GitHub Actions"
  GIT_COMMITTER_EMAIL: "github-actions@github.com"

# ============================================================
# ðŸ”„ Jobs
# ============================================================
jobs:
  release:
    name: "ðŸš€ Release"
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      # -------------------------------------------------------
      # ðŸ“‹ Setup
      # -------------------------------------------------------
      - name: "â¬‡ï¸ Checkout Repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for correct versioning
          persist-credentials: true
          token: ${{ secrets.PAT }}

      - name: "ðŸ” Initialize Workflow"
        id: init
        run: |
          echo "::group::Environment Information"
          echo "ðŸ”¹ Repository: ${{ github.repository }}"
          echo "ðŸ”¹ Branch: ${{ github.ref_name }}"
          echo "ðŸ”¹ Trigger: ${{ github.event_name }}"
          echo "ðŸ”¹ Commit: ${{ github.sha }}"
          echo "ðŸ”¹ Mode: ${{ env.DRY_RUN == 'true' && 'Dry Run' || 'Release' }}"
          echo "ðŸ”¹ Debug: ${{ github.event.inputs.debug == 'true' && 'Enabled' || 'Disabled' }}"
          echo "::endgroup::"

          # Extract Bun version from package.json
          BUN_VERSION=$(node -e "try { const pkg = require('./package.json'); const pm = pkg.packageManager || ''; const version = pm.match(/bun@(.*)/); console.log(version ? version[1] : '1.2.10'); } catch (e) { console.log('1.2.10'); }")
          echo "bun_version=${BUN_VERSION}" >> $GITHUB_OUTPUT

          # Get last tag for reference
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "none")
          echo "last_tag=${LAST_TAG}" >> $GITHUB_OUTPUT
          echo "::notice::Last release tag: ${LAST_TAG}"

      # -------------------------------------------------------
      # âš™ï¸ Runtime Setup
      # -------------------------------------------------------
      - name: "ðŸ§° Setup Bun"
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ steps.init.outputs.bun_version }}

      - name: "ðŸ“¦ Install Dependencies"
        id: deps
        run: |
          echo "::group::Dependency Installation"
          bun install --frozen-lockfile
          # Verify integrity
          bun audit signatures
          echo "::endgroup::"

      # -------------------------------------------------------
      # ðŸ§ª Validation
      # -------------------------------------------------------
      - name: "ðŸ” Validate Project"
        id: validate
        if: ${{ env.DRY_RUN != 'true' }}
        run: |
          echo "::group::Project Validation"
          echo "ðŸ”¹ Running TypeScript checks..."
          bun run type-check

          echo "ðŸ”¹ Running tests..."
          bun run test:ci
          echo "::endgroup::"

      # -------------------------------------------------------
      # ðŸš€ Semantic Release
      # -------------------------------------------------------
      - name: "ðŸš€ Run Semantic Release"
        id: semantic-release
        env:
          GH_TOKEN: ${{ secrets.PAT }}
        run: |
          echo "::group::Semantic Release Process"

          # Configure release flags based on inputs
          FLAGS=""
          if [[ "${{ env.DRY_RUN }}" == "true" ]]; then
            FLAGS="--dry-run"
            echo "Running in dry-run mode (no actual release)"
          fi

          # Add debug flags if needed
          if [[ "${{ github.event.inputs.debug }}" == "true" ]]; then
            FLAGS="${FLAGS} --debug"
            echo "Debug mode enabled"
          fi

          # Execute semantic-release with Bun
          echo "Executing: bunx semantic-release ${FLAGS}"
          OUTPUT=$(bunx semantic-release ${FLAGS})
          STATUS=$?

          # Store output for inspection
          echo "$OUTPUT" > semantic-release-output.log

          # Handle output
          if [ $STATUS -eq 0 ]; then
            echo "::notice::Semantic release completed successfully"

            # Try to extract the released version from output
            VERSION=$(echo "$OUTPUT" | grep -oP "(?:The next release version is|Published release )\K[0-9]+\.[0-9]+\.[0-9]+" || echo "")

            if [[ -n "$VERSION" ]]; then
              echo "version=${VERSION}" >> $GITHUB_OUTPUT
              echo "::notice::Version v${VERSION} released!"
            elif [[ "${{ env.DRY_RUN }}" == "true" ]]; then
              echo "status=dry-run" >> $GITHUB_OUTPUT
              echo "::notice::Dry run completed successfully"
            else
              echo "status=no-release" >> $GITHUB_OUTPUT
              echo "::notice::No release required - no relevant changes detected"
            fi
          else
            echo "::error::Semantic release failed with exit code $STATUS"
            echo "$OUTPUT" | grep -E "ERR|Error|WARN|Warning" || echo "$OUTPUT" | tail -n 20
            exit $STATUS
          fi

          echo "::endgroup::"

      # -------------------------------------------------------
      # ðŸ”„ Back-Merge & Synchronize Branches
      # -------------------------------------------------------
      - name: "ðŸ”„ Back-Merge & Synchronize Branches"
        id: back-merge
        if: steps.semantic-release.outputs.version != '' && env.DRY_RUN != 'true'
        env:
          GH_TOKEN: ${{ secrets.PAT }}
        run: |
          echo "::group::Back-Merge and Branch Synchronization"
          echo "ðŸ”¹ Setting git configuration..."
          git config --global user.name "${{ env.GIT_AUTHOR_NAME }}"
          git config --global user.email "${{ env.GIT_AUTHOR_EMAIL }}"

          # Check if develop branch exists
          echo "ðŸ”¹ Checking for develop branch..."
          if git show-ref --verify --quiet refs/remotes/origin/develop; then
            echo "âœ… Found develop branch"

            echo "ðŸ”¹ Fetching latest changes from all branches..."
            git fetch origin --prune

            echo "ðŸ”¹ Ensure we're on master with latest changes..."
            git checkout master
            git pull origin master

            echo "ðŸ”¹ Getting the latest commit hash from master..."
            MASTER_COMMIT=$(git rev-parse HEAD)
            echo "Master is at commit: $MASTER_COMMIT"

            echo "ðŸ”¹ Checking out develop branch..."
            git checkout develop
            git pull origin develop

            echo "ðŸ”¹ Resetting develop to exactly match master..."
            git reset --hard origin/master

            echo "ðŸ”¹ Pushing updated develop branch..."
            git push origin develop --force

            echo "ðŸ”¹ Verifying branches are identical..."
            git checkout master
            MASTER_HEAD=$(git rev-parse HEAD)
            git checkout develop
            DEVELOP_HEAD=$(git rev-parse HEAD)

            if [ "$MASTER_HEAD" = "$DEVELOP_HEAD" ]; then
              echo "âœ… Success! Both branches are now identical at commit: $MASTER_HEAD"
            else
              echo "âš ï¸ Warning: Branches are not identical!"
              echo "Master: $MASTER_HEAD"
              echo "Develop: $DEVELOP_HEAD"
              exit 1
            fi

            # List all branches and delete all except master and develop
            echo "ðŸ”¹ Cleaning up other branches..."
            git checkout master

            # Delete local branches except master and develop
            for branch in $(git branch | grep -v "master" | grep -v "develop" | tr -d " *"); do
              echo "Deleting local branch: $branch"
              git branch -D $branch
            done

            # Delete remote branches except master and develop
            for branch in $(git branch -r | grep "origin/" | grep -v "origin/master" | grep -v "origin/develop" | sed 's/origin\///'); do
              echo "Deleting remote branch: $branch"
              git push origin --delete $branch
            done

            echo "âœ… Successfully synchronized master and develop branches and removed other branches"
            echo "back_merge_status=success" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ No develop branch found, skipping synchronization"
            echo "back_merge_status=skipped" >> $GITHUB_OUTPUT
          fi
          echo "::endgroup::"

      # -------------------------------------------------------
      # ðŸ“Š Release Summary
      # -------------------------------------------------------
      - name: "ðŸ“Š Generate Release Summary"
        if: always()
        run: |
          echo "# Semantic Release Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # If we have version output, a release happened
          if [[ "${{ steps.semantic-release.outputs.version }}" != "" ]]; then
            echo "âœ… **Version ${{ steps.semantic-release.outputs.version }} released successfully**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Add changelog info if available
            if [[ -f "CHANGELOG.md" ]]; then
              echo "## Release Notes" >> $GITHUB_STEP_SUMMARY
              echo "See [CHANGELOG.md](../blob/master/CHANGELOG.md) for detailed release notes." >> $GITHUB_STEP_SUMMARY

              # Extract the latest release notes from CHANGELOG.md
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Latest Changes" >> $GITHUB_STEP_SUMMARY
              echo "```" >> $GITHUB_STEP_SUMMARY
              sed -n "/## \[${{ steps.semantic-release.outputs.version }}/,/## \[/p" CHANGELOG.md | sed '1p;/## \[/d' | head -n 15 >> $GITHUB_STEP_SUMMARY
              echo "..." >> $GITHUB_STEP_SUMMARY
              echo "```" >> $GITHUB_STEP_SUMMARY
            fi

          elif [[ "${{ steps.semantic-release.outputs.status }}" == "dry-run" ]]; then
            echo "âœ… **Dry run completed successfully**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No changes were made to the repository." >> $GITHUB_STEP_SUMMARY

          elif [[ "${{ steps.semantic-release.outputs.status }}" == "no-release" ]]; then
            echo "â„¹ï¸ **No new version released**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No changes that would trigger a semantic version bump were detected." >> $GITHUB_STEP_SUMMARY

          elif [[ "${{ job.status }}" != "success" ]]; then
            echo "âŒ **Release process failed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the workflow logs for more information." >> $GITHUB_STEP_SUMMARY
          fi

          # Add execution stats
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Execution Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** [\`${GITHUB_SHA:0:7}\`](../commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow Run:** [#${{ github.run_number }}](../actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "- **Previous Release:** ${{ steps.init.outputs.last_tag }}" >> $GITHUB_STEP_SUMMARY

      # -------------------------------------------------------
      # ðŸ“¦ Upload Artifacts
      # -------------------------------------------------------
      - name: "ðŸ“¤ Upload Release Output Artifact"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: semantic-release-output-${{ github.run_id }}
          path: |
            semantic-release-output.log
            CHANGELOG.md
          retention-days: 7
          if-no-files-found: ignore
