name: "Semantic Release"

# ============================================================
# Workflow triggers
# ============================================================
on:
  push:
    branches:
      - master
  workflow_dispatch:
    inputs:
      debug:
        description: "Enable debug logging"
        required: false
        type: choice
        options: ["true", "false"]
      dry_run:
        description: "Run in dry-run mode"
        type: boolean
        default: false

# ============================================================
# Concurrency control
# ============================================================
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# ============================================================
# Permissions
# ============================================================
permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write

# ============================================================
# Environment variables
# ============================================================
env:
  NODE_ENV: "production"
  BUN_RUNTIME_SAFETY: "true"
  DEBUG: ${{ (github.event.inputs.debug == 'true' && 'semantic-release:*') || '' }}
  DRY_RUN: ${{ (github.event.inputs.dry_run == 'true' && 'true') || 'false' }}
  GIT_AUTHOR_NAME: "GitHub Actions"
  GIT_AUTHOR_EMAIL: "github-actions@github.com"
  GIT_COMMITTER_NAME: "GitHub Actions"
  GIT_COMMITTER_EMAIL: "github-actions@github.com"
  LEFTHOOK: "0"

# ============================================================
# Jobs
# ============================================================
jobs:
  release:
    name: "ðŸš€ Release"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      version: ${{ steps.check-release.outputs.new_release_version }}
      release_upload_url: ${{ steps.check-release.outputs.release_upload_url }}
      latest_tag: ${{ steps.check-release.outputs.latest_tag }}
      provenance_assets: ${{ steps.generate-provenance.outputs.provenance_assets }}
      skip_ci: ${{ steps.skip-ci-check.outputs.skip_ci }}
    steps:
      # ============================================================
      # Checkout Repository
      # ============================================================
      - name: "Checkout Repository"
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5
        with:
          fetch-depth: 0
          persist-credentials: false

      # ============================================================
      # Setup Bun
      # ============================================================
      - name: "Setup Bun"
        uses: oven-sh/setup-bun@735343b667d3e6f658f44d0eca948eb6282f2b76 # v2
        with:
          bun-version: latest

      # ============================================================
      # Restore Dependencies Cache
      # ============================================================
      - name: "Restore Dependencies Cache"
        id: cache-deps
        uses: actions/cache/restore@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: |
            ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      # ============================================================
      # Install Dependencies
      # ============================================================
      - name: "Install Dependencies"
        run: |
          if [[ "${{ steps.cache-deps.outputs.cache-hit }}" != "true" ]]; then
            echo "::group::Installing dependencies"
          else
            echo "::notice::Using cached dependencies"
          fi
          bun install --frozen-lockfile --no-summary
          echo "::endgroup::"

      - name: "Save Dependencies Cache"
        if: always() && steps.cache-deps.outputs.cache-hit != 'true'
        uses: actions/cache/save@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: |
            ~/.bun/install/cache
          key: ${{ steps.cache-deps.outputs.cache-primary-key }}

      # ============================================================
      # Check for Skip CI Commits
      # ============================================================
      - name: "Check for Skip CI Commits"
        id: skip-ci-check
        run: |
          # Check if the current commit message contains [skip ci] or similar
          COMMIT_MSG=$(git log -1 --pretty=%B)
          if echo "$COMMIT_MSG" | grep -qE '\[skip ci\]|\[ci skip\]|\[no ci\]|\[skip actions\]'; then
            echo "skip_ci=true" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Skip CI detected in commit message. Will run semantic-release but skip validation steps."
          else
            echo "skip_ci=false" >> $GITHUB_OUTPUT
            echo "âœ… No skip CI detected. Running full validation."
          fi

      # ============================================================
      # Validate Project (only if not dry-run and not skip ci)
      # ============================================================
      - name: "Validate Project"
        if: ${{ env.DRY_RUN != 'true' && steps.skip-ci-check.outputs.skip_ci != 'true' }}
        run: |
          echo "::group::Project Validation"
          bun run type-check && bun run src/scripts/test-pretty.ts --no-live && bunx ultracite fix src && bunx ultracite check src
          echo "::endgroup::"

      # ============================================================
      # Security Audit (optional, continue on error)
      # ============================================================
      - name: "Security Audit"
        if: ${{ env.DRY_RUN != 'true' && steps.skip-ci-check.outputs.skip_ci != 'true' }}
        continue-on-error: true
        run: |
          echo "::group::Security Audit"
          if bun audit --level high > bun-audit.txt; then
            echo "âœ… No high or critical vulnerabilities found."
          else
            echo "::warning::High or critical vulnerabilities found by bun audit."
            cat bun-audit.txt
          fi
          echo "::endgroup::"

      # ============================================================
      # Run Semantic Release
      # ============================================================
      - name: "Setup Node"
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: "lts/*"

      - name: "Run Semantic Release"
        id: semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Build flags based on inputs
          FLAGS=""
          if [[ "${{ env.DRY_RUN }}" == "true" ]]; then
            FLAGS="--dry-run"
          fi
          if [[ "${{ github.event.inputs.debug }}" == "true" ]]; then
            FLAGS="${FLAGS} --debug"
          fi

          echo "::group::Running Semantic Release"

          # Handle skip CI gracefully - semantic-release will still run but won't create releases
          if [[ "${{ steps.skip-ci-check.outputs.skip_ci }}" == "true" ]]; then
            echo "â„¹ï¸ Skip CI detected - semantic-release will analyze commits but won't create releases"
            echo "This is expected behavior for [skip ci] commits"
          fi

          npx semantic-release@latest $FLAGS
          echo "::endgroup::"

      # ============================================================
      # Check for New Release
      # ============================================================
      - name: "Check for New Release"
        id: check-release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LATEST_TAG_AFTER=$(git describe --tags --abbrev=0 2>/dev/null || echo 'none')
          echo "latest_tag=${LATEST_TAG_AFTER}" >> $GITHUB_OUTPUT

          # Get the tag before semantic-release ran
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo 'none')

          if [ "$PREVIOUS_TAG" != "$LATEST_TAG_AFTER" ] && [ "$LATEST_TAG_AFTER" != "none" ]; then
            echo "âœ… New release detected: $LATEST_TAG_AFTER"
            echo "new_release_version=${LATEST_TAG_AFTER#v}" >> $GITHUB_OUTPUT
            RELEASE_UPLOAD_URL=$(gh release view "$LATEST_TAG_AFTER" --json uploadUrl -q .uploadUrl)
            echo "release_upload_url=${RELEASE_UPLOAD_URL}" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸ No new release detected."
            echo "new_release_version=" >> $GITHUB_OUTPUT
            echo "release_upload_url=" >> $GITHUB_OUTPUT
            
            # Check if semantic-release ran successfully but found no commits to release
            if [ -f ".releaserc.js" ]; then
              if [[ "${{ steps.skip-ci-check.outputs.skip_ci }}" == "true" ]]; then
                echo "â„¹ï¸ Skip CI commit detected - this is expected behavior for [skip ci] commits"
              else
                echo "â„¹ï¸ Semantic-release completed but found no commits that trigger a release."
                echo "This is normal for chore commits that don't match the release rules."
              fi
            fi
          fi

      # ============================================================
      # Upload Changelog Artifact (only if release created)
      # ============================================================
      - name: "Upload Changelog Artifact"
        if: steps.check-release.outputs.new_release_version != ''
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: changelog
          path: CHANGELOG.md

      # ============================================================
      # Generate Provenance Assets (only if release created)
      # ============================================================
      - name: "Generate Provenance Assets"
        id: generate-provenance
        if: steps.check-release.outputs.new_release_version != ''
        run: |
          # Generate SHA256 hashes in the correct format for SLSA
          ASSETS=("CHANGELOG.md" "package.json" "bun.lock" "bunfig.toml" "README.md")
          CONTENT=""
          for asset in "${ASSETS[@]}"; do
            if [ -f "$asset" ]; then
              # Generate SHA256 hash in format: SHA256 NAME
              HASH=$(sha256sum "$asset")
              CONTENT+="$HASH"
              CONTENT+=$'\n'
            fi
          done
          # Base64 encode the content for SLSA
          echo "provenance_assets=$(echo -n "$CONTENT" | base64 -w0)" >> $GITHUB_OUTPUT

  # SLSA provenance temporarily disabled to avoid failing the workflow when no subjects are present.

  # ============================================================
  # Generate Release Summary
  # ============================================================
  generate-summary:
    name: "Generate Release Summary"
    needs: [release]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: "Download Changelog"
        if: needs.release.outputs.version != ''
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: changelog
          merge-multiple: false
          repository: ${{ github.repository }}
          run-id: ${{ github.run_id }}
        continue-on-error: true

      - name: "Generate Summary"
        id: summary
        run: |
          VERSION="${{ needs.release.outputs.version }}"
          SKIP_CI="${{ needs.release.outputs.skip_ci }}"
          echo "# Semantic Release Results" >> $GITHUB_STEP_SUMMARY

          if [[ "$VERSION" != "" ]]; then
            echo "âœ… **Version $VERSION released successfully**" >> $GITHUB_STEP_SUMMARY
            if [ -f "CHANGELOG.md" ]; then
              echo "ðŸ“‹ **Changelog generated**" >> $GITHUB_STEP_SUMMARY
            fi
            echo "ðŸ”’ **SLSA provenance generated**" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ github.event.inputs.dry_run }}" == "true" ]]; then
            echo "âœ… **Dry run completed successfully**" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.release.result }}" != "success" ]]; then
            echo "âŒ **Release process failed**" >> $GITHUB_STEP_SUMMARY
            echo "Check the logs above for detailed error information." >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **No new version released**" >> $GITHUB_STEP_SUMMARY
            if [[ "$SKIP_CI" == "true" ]]; then
              echo "This is expected for commits with [skip ci] - semantic-release analyzed commits but did not create a release." >> $GITHUB_STEP_SUMMARY
            else
              echo "This is normal for chore commits or when no semantic changes are detected." >> $GITHUB_STEP_SUMMARY
              echo "The commit analyzer determined no release was needed based on the commit messages." >> $GITHUB_STEP_SUMMARY
            fi
          fi

          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "N/A")
          echo "- **Previous Release:** $LAST_TAG" >> $GITHUB_STEP_SUMMARY

          # Add commit analysis information
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Commit Analysis" >> $GITHUB_STEP_SUMMARY
          echo "The following commit types trigger releases:" >> $GITHUB_STEP_SUMMARY
          echo "- `feat:` â†’ Minor release" >> $GITHUB_STEP_SUMMARY
          echo "- `fix:` â†’ Patch release" >> $GITHUB_STEP_SUMMARY
          echo "- `chore(deps):` â†’ Patch release" >> $GITHUB_STEP_SUMMARY
          echo "- `chore(actions):` â†’ Patch release" >> $GITHUB_STEP_SUMMARY
          echo "- `chore(bun):` â†’ Patch release" >> $GITHUB_STEP_SUMMARY
          echo "- `docs:`, `style:`, `refactor:`, `perf:`, `build:`, `ci:`, `test:` â†’ Patch release" >> $GITHUB_STEP_SUMMARY
          echo "- Other `chore:` commits â†’ No release" >> $GITHUB_STEP_SUMMARY
          echo "- Commits with `[skip ci]` â†’ No release (by design)" >> $GITHUB_STEP_SUMMARY
