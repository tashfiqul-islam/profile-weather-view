name: Semantic Release

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Workflow triggers
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
on:
  push:
    branches:
      - master
  workflow_dispatch:
    inputs:
      debug:
        description: "Enable debug logging"
        required: false
        type: choice
        options: ["true", "false"]
      dry_run:
        description: "Run in dry-run mode"
        type: boolean
        default: false

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Concurrency control
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Permissions
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Environment variables
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
env:
  NODE_ENV: production
  BUN_RUNTIME_SAFETY: "true"
  DEBUG: ${{ (github.event.inputs.debug == 'true' && 'semantic-release:*') || '' }}
  DRY_RUN: ${{ (github.event.inputs.dry_run == 'true' && 'true') || 'false' }}
  GIT_AUTHOR_NAME: github-actions[bot]
  GIT_AUTHOR_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com
  GIT_COMMITTER_NAME: github-actions[bot]
  GIT_COMMITTER_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com
  LEFTHOOK: "0"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Jobs
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
jobs:
  release:
    name: ðŸš€ Release
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      version: ${{ steps.check-release.outputs.new_release_version }}
      release_upload_url: ${{ steps.check-release.outputs.release_upload_url }}
      latest_tag: ${{ steps.check-release.outputs.latest_tag }}
      provenance_assets: ${{ steps.generate-provenance.outputs.provenance_assets }}
      skip_ci: ${{ steps.skip-ci-check.outputs.skip_ci }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup Bun
        uses: oven-sh/setup-bun@b7a1c7ccf290d58743029c4f6903da283811b979 # v2.1.0
        with:
          bun-version: latest

      - name: Restore dependencies cache
        id: cache-deps
        uses: actions/cache/restore@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: |
            ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: |
          if [[ "${{ steps.cache-deps.outputs.cache-hit }}" != "true" ]]; then
            echo "::group::Installing dependencies"
          else
            echo "::notice::Using cached dependencies"
          fi
          bun install --frozen-lockfile --no-summary
          echo "::endgroup::"

      - name: Save dependencies cache
        if: always() && steps.cache-deps.outputs.cache-hit != 'true'
        uses: actions/cache/save@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: |
            ~/.bun/install/cache
          key: ${{ steps.cache-deps.outputs.cache-primary-key }}

      - name: Check for skip CI commits
        id: skip-ci-check
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          if echo "$COMMIT_MSG" | grep -qE '\[skip ci\]|\[ci skip\]|\[no ci\]|\[skip actions\]'; then
            echo "skip_ci=true" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Skip CI detected in commit message. Will run semantic-release but skip validation steps."
          else
            echo "skip_ci=false" >> $GITHUB_OUTPUT
            echo "âœ… No skip CI detected. Running full validation."
          fi

      - name: Validate project
        if: env.DRY_RUN != 'true' && steps.skip-ci-check.outputs.skip_ci != 'true'
        run: |
          echo "::group::Project Validation"
          bun run typecheck && bun test && bunx ultracite fix src && bunx ultracite check src
          echo "::endgroup::"

      - name: Security audit
        if: env.DRY_RUN != 'true' && steps.skip-ci-check.outputs.skip_ci != 'true'
        continue-on-error: true
        run: |
          echo "::group::Security Audit"
          if bun audit --level high > bun-audit.txt; then
            echo "âœ… No high or critical vulnerabilities found."
          else
            echo "::warning::High or critical vulnerabilities found by bun audit."
            cat bun-audit.txt
          fi
          echo "::endgroup::"

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: "lts/*"

      - name: Run semantic release
        id: semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          FLAGS=""
          if [[ "${{ env.DRY_RUN }}" == "true" ]]; then
            FLAGS="--dry-run"
          fi
          if [[ "${{ github.event.inputs.debug }}" == "true" ]]; then
            FLAGS="${FLAGS} --debug"
          fi

          echo "::group::Running Semantic Release"

          if [[ "${{ steps.skip-ci-check.outputs.skip_ci }}" == "true" ]]; then
            echo "â„¹ï¸ Skip CI detected - semantic-release will analyze commits but won't create releases"
            echo "This is expected behavior for [skip ci] commits"
          fi

          npx semantic-release@latest $FLAGS
          echo "::endgroup::"

      - name: Check for new release
        id: check-release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LATEST_TAG_AFTER=$(git describe --tags --abbrev=0 2>/dev/null || echo 'none')
          echo "latest_tag=${LATEST_TAG_AFTER}" >> $GITHUB_OUTPUT

          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo 'none')

          if [ "$PREVIOUS_TAG" != "$LATEST_TAG_AFTER" ] && [ "$LATEST_TAG_AFTER" != "none" ]; then
            echo "âœ… New release detected: $LATEST_TAG_AFTER"
            echo "new_release_version=${LATEST_TAG_AFTER#v}" >> $GITHUB_OUTPUT
            RELEASE_UPLOAD_URL=$(gh release view "$LATEST_TAG_AFTER" --json uploadUrl -q .uploadUrl)
            echo "release_upload_url=${RELEASE_UPLOAD_URL}" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸ No new release detected."
            echo "new_release_version=" >> $GITHUB_OUTPUT
            echo "release_upload_url=" >> $GITHUB_OUTPUT

            if [ -f ".releaserc.js" ]; then
              if [[ "${{ steps.skip-ci-check.outputs.skip_ci }}" == "true" ]]; then
                echo "â„¹ï¸ Skip CI commit detected - this is expected behavior for [skip ci] commits"
              else
                echo "â„¹ï¸ Semantic-release completed but found no commits that trigger a release."
                echo "This is normal for chore commits that don't match the release rules."
              fi
            fi
          fi

      - name: Upload changelog artifact
        if: steps.check-release.outputs.new_release_version != ''
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: changelog
          path: CHANGELOG.md

      - name: Generate provenance assets
        id: generate-provenance
        if: steps.check-release.outputs.new_release_version != ''
        run: |
          ASSETS=("CHANGELOG.md" "package.json" "bun.lock" "bunfig.toml" "README.md")
          CONTENT=""
          for asset in "${ASSETS[@]}"; do
            if [ -f "$asset" ]; then
              HASH=$(sha256sum "$asset")
              CONTENT+="$HASH"
              CONTENT+=$'\n'
            fi
          done
          echo "provenance_assets=$(echo -n "$CONTENT" | base64 -w0)" >> $GITHUB_OUTPUT

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Generate Release Summary
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  generate-summary:
    name: Generate Release Summary
    needs: [release]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Download changelog
        if: needs.release.outputs.version != ''
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: changelog
          merge-multiple: false
          repository: ${{ github.repository }}
          run-id: ${{ github.run_id }}
        continue-on-error: true

      - name: Generate summary
        id: summary
        run: |
          VERSION="${{ needs.release.outputs.version }}"
          SKIP_CI="${{ needs.release.outputs.skip_ci }}"

          {
            echo "## Semantic Release Results"
            echo ""

            if [[ "$VERSION" != "" ]]; then
              echo "âœ… **Version $VERSION released successfully**"
              if [ -f "CHANGELOG.md" ]; then
                echo "ðŸ“‹ **Changelog generated**"
              fi
              echo "ðŸ”’ **SLSA provenance generated**"
            elif [[ "${{ github.event.inputs.dry_run }}" == "true" ]]; then
              echo "âœ… **Dry run completed successfully**"
            elif [[ "${{ needs.release.result }}" != "success" ]]; then
              echo "âŒ **Release process failed**"
              echo "Check the logs above for detailed error information."
            else
              echo "â„¹ï¸ **No new version released**"
              if [[ "$SKIP_CI" == "true" ]]; then
                echo "This is expected for commits with [skip ci] - semantic-release analyzed commits but did not create a release."
              else
                echo "This is normal for chore commits or when no semantic changes are detected."
                echo "The commit analyzer determined no release was needed based on the commit messages."
              fi
            fi

            echo ""
            echo "## Commit Analysis"
            echo "The following commit types trigger releases:"
            echo "- \`feat:\` â†’ Minor release"
            echo "- \`fix:\` â†’ Patch release"
            echo "- \`chore(deps):\` â†’ Patch release"
            echo "- \`chore(actions):\` â†’ Patch release"
            echo "- \`chore(bun):\` â†’ Patch release"
            echo "- \`docs:\`, \`style:\`, \`refactor:\`, \`perf:\`, \`build:\`, \`ci:\`, \`test:\` â†’ Patch release"
            echo "- Other \`chore:\` commits â†’ No release"
            echo "- Commits with \`[skip ci]\` â†’ No release (by design)"
          } >> "$GITHUB_STEP_SUMMARY"
