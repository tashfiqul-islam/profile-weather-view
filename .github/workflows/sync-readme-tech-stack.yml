name: "üõ†Ô∏è Sync README Tech Stack"

# ============================================================
# üöÄ Triggers
# ============================================================
on:
  push:
    branches: [ master ]
    paths:
      - 'package.json'
      - 'bun.lock'
  workflow_dispatch:

# ============================================================
# üîÅ Concurrency (single run per ref)
# ============================================================
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

# ============================================================
# üîí Permissions (least privilege)
# ============================================================
permissions:
  contents: write

# ============================================================
# üìå Job: Sync README
# ============================================================
jobs:
  sync:
    name: "üîÑ Sync Versions & Footer"
    runs-on: ubuntu-latest
    timeout-minutes: 3
    if: |
      !contains(github.event.head_commit.message, '[skip actions]')
    env:
      CACHE_KEY_PREFIX: v1-sync-readme
      TIMEZONE: Asia/Dhaka
    steps:
      - name: "‚¨áÔ∏è Checkout Repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: "üèóÔ∏è Setup Bun"
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: "üì¶ Restore Dependencies Cache"
        id: cache-deps
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            ~/.bun/install/cache
            bun.lock
          key: ${{ env.CACHE_KEY_PREFIX }}-${{ runner.os }}-bun-${{ hashFiles('package.json', 'bun.lock') }}
          restore-keys: |
            ${{ env.CACHE_KEY_PREFIX }}-${{ runner.os }}-bun-

      - name: "üîÑ Install Dependencies"
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: |
          echo "::group::Bun Installation"
          bun --version
          bun install --frozen-lockfile
          echo "::endgroup::"

      - name: "‚ö° Install Dependencies (Fast Path)"
        if: steps.cache-deps.outputs.cache-hit == 'true'
        run: |
          echo "::notice::Using cached dependencies"
          bun install --frozen-lockfile --no-summary

      - name: "üß© Sync README tech stack badges & footer"
        run: |
          echo "::group::Sync README"
          bun run sync-readme-tech-stack
          echo "::endgroup::"

      - name: "üîß Normalize GPG private key"
        id: normalize-gpg
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          set -euo pipefail
          if [ -z "${GPG_PRIVATE_KEY}" ]; then
            echo "::error::Missing secret GPG_PRIVATE_KEY"; exit 1; fi
          tmpdir="$(mktemp -d)"
          raw="$tmpdir/key.raw"
          asc="$tmpdir/key.asc"
          printf '%s' "${GPG_PRIVATE_KEY}" > "$raw"
          if grep -q "BEGIN PGP PRIVATE KEY BLOCK" "$raw"; then
            tr -d '\r' < "$raw" > "$asc"
          else
            if printf '%s' "${GPG_PRIVATE_KEY}" | base64 -d > "$asc" 2>/dev/null && grep -q "BEGIN PGP PRIVATE KEY BLOCK" "$asc"; then
              :
            else
              printf '%s' "${GPG_PRIVATE_KEY}" | sed 's/\\n/\n/g' | tr -d '\r' > "$asc"
              if ! grep -q "BEGIN PGP PRIVATE KEY BLOCK" "$asc"; then
                echo "::error::GPG_PRIVATE_KEY is not ASCII-armored. Re-export with 'gpg --export-secret-keys --armor KEY_ID' and paste full block including BEGIN/END lines."; exit 1; fi
            fi
          fi
          if ! grep -q "END PGP PRIVATE KEY BLOCK" "$asc"; then
            echo "::error::GPG_PRIVATE_KEY footer missing. Ensure END line is present."; exit 1; fi
          {
            echo "key<<'EOF'"
            cat "$asc"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: "üîê Setup GPG for Commit Signing"
        id: gpg
        uses: crazy-max/ghaction-import-gpg@v6.3.0
        with:
          gpg_private_key: ${{ steps.normalize-gpg.outputs.key }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}
          git_user_signingkey: true
          git_commit_gpgsign: true
          git_tag_gpgsign: true
          git_push_gpgsign: if-asked
        env:
          GPG_TTY: /dev/console

      - name: "üë§ Configure Git Identity"
        run: |
          git config --global user.name "${{ secrets.GIT_COMMITTER_NAME || github.repository_owner }}"
          git config --global user.email "${{ secrets.GIT_COMMITTER_EMAIL }}"

      - name: "üíæ Commit Changes"
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then \
          git add README.md && \
          git commit -S --no-verify -m "docs(readme): sync tech stack badges and footer date [skip actions]"; \
          fi

      - name: "‚¨ÜÔ∏è Push"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then \
          git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }} HEAD:${{ github.ref_name }}; \
          fi

      - name: "üíæ Save Dependencies Cache"
        if: always() && steps.cache-deps.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: |
            node_modules
            ~/.bun/install/cache
            bun.lock
          key: ${{ steps.cache-deps.outputs.cache-primary-key }}


